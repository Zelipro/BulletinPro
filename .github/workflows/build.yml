name: Build BulletinPro - Linux & Windows

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Versioning
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  
  # Python et Flet versions
  PYTHON_VERSION: 3.12.8
  FLET_CLI_VERSION: 0.27.5
  
  # Fix encodage et affichage
  PYTHONUTF8: 1
  FLET_CLI_NO_RICH_OUTPUT: 1
  UV_NO_PROGRESS: 1

jobs:
  build-linux:
    name: ðŸ§ Build Linux (.deb)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install flet-cli ${{ env.FLET_CLI_VERSION }}
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==$FLET_CLI_VERSION
      
      - name: ðŸ”§ Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
      
      - name: ðŸ“š Install Python project dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ”¨ Flet Build Linux
        run: |
          flet build linux --verbose --build-number=$BUILD_NUMBER --build-version=$BUILD_VERSION
      
      - name: ðŸ” Verify build output
        run: |
          echo "=== Contents of build/linux ==="
          ls -lhR build/linux || echo "build/linux not found"
          
          echo ""
          echo "=== Searching for .deb files ==="
          find build -name "*.deb" -type f || echo "No .deb files found"
      
      - name: ðŸ“¤ Upload Linux Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: bulletinpro-linux-build
          path: build/linux
          if-no-files-found: error
          overwrite: false

  build-windows:
    name: ðŸªŸ Build Windows (.exe)
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install flet-cli ${{ env.FLET_CLI_VERSION }}
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==$env:FLET_CLI_VERSION
      
      - name: ðŸ“š Install Python project dependencies
        run: |
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          }
      
      - name: ðŸ”¨ Flet Build Windows
        run: |
          flet build windows --verbose --no-rich-output --build-number=$env:BUILD_NUMBER --build-version=$env:BUILD_VERSION
      
      - name: ðŸ” Verify build output
        run: |
          Write-Host "=== Contents of build/windows ==="
          if (Test-Path build/windows) {
            Get-ChildItem -Path build/windows -Recurse | Format-Table -AutoSize
          } else {
            Write-Host "build/windows not found"
          }
          
          Write-Host ""
          Write-Host "=== Searching for .exe files ==="
          if (Test-Path build) {
            Get-ChildItem -Path build -Recurse -Filter *.exe -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host $_.FullName
            }
          }
      
      - name: ðŸ“¤ Upload Windows Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: bulletinpro-windows-build
          path: build/windows
          if-no-files-found: error
          overwrite: false

  create-release:
    name: ðŸš€ Create Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: bulletinpro-linux-build
          path: ./release/linux
      
      - name: ðŸ“¥ Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: bulletinpro-windows-build
          path: ./release/windows
      
      - name: ðŸ“‹ List downloaded artifacts
        run: |
          echo "=== Linux build ==="
          ls -lhR ./release/linux/
          
          echo ""
          echo "=== Windows build ==="
          ls -lhR ./release/windows/
      
      - name: ðŸ“¦ Create distribution packages
        run: |
          # CrÃ©er des archives pour faciliter le tÃ©lÃ©chargement
          cd release/linux
          if [ -f *.deb ]; then
            cp *.deb ../../BulletinPro-Linux.deb
          fi
          cd ../..
          
          cd release/windows
          if [ -d * ]; then
            zip -r ../../BulletinPro-Windows.zip ./*
          fi
          cd ../..
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            BulletinPro-Linux.deb
            BulletinPro-Windows.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸ“¦ BulletinPro ${{ github.ref_name }}
            
            ### ðŸ“¥ Installation
            
            **Linux (Ubuntu/Debian):**
            ```bash
            sudo dpkg -i BulletinPro-Linux.deb
            ```
            
            **Windows:**
            1. TÃ©lÃ©chargez `BulletinPro-Windows.zip`
            2. Extrayez le contenu
            3. Lancez l'exÃ©cutable
            
            ### ðŸ“ Notes
            - Build version: ${{ env.BUILD_VERSION }}
            - Build number: ${{ env.BUILD_NUMBER }}
            
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: ðŸ“Š Build Summary
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ‰ BulletinPro Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Version: $BUILD_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Build Number: $BUILD_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- Python: $PYTHON_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Flet CLI: $FLET_CLI_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸªŸ Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-linux.result }}" = "success" ] && [ "${{ needs.build-windows.result }}" = "success" ]; then
            echo "### âœ… Tous les builds ont rÃ©ussi!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **TÃ©lÃ©chargez les artifacts** dans la section ci-dessous." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Certains builds ont Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs des jobs en erreur pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
          fi
