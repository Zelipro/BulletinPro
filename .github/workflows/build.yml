name: Build BulletinPro - Hybrid (Flet + PyInstaller)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.12.8

jobs:
  # Build avec Flet (natif Flutter)
  build-flet:
    name: ðŸ¦‹ Flet Build - ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
            build-cmd: linux
            artifact: build/linux
          - os: Windows
            runner: windows-latest
            build-cmd: windows
            artifact: build/windows
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ¦‹ Setup Flutter 3.30+
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.30.0'
          channel: 'stable'
      
      - name: ðŸ”§ Install system deps (Linux)
        if: matrix.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y ninja-build libgtk-3-dev
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==0.27.5
          pip install -r requirements.txt
      
      - name: ðŸ”¨ Build with Flet
        run: flet build ${{ matrix.build-cmd }} --build-version=${{ env.BUILD_VERSION }}
      
      - name: ðŸ“¤ Upload Flet artifact
        uses: actions/upload-artifact@v4
        with:
          name: flet-${{ matrix.os }}-build
          path: ${{ matrix.artifact }}
          if-no-files-found: error

  # Build avec PyInstaller (fallback)
  build-pyinstaller:
    name: ðŸ PyInstaller - ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
            separator: ':'
          - os: Windows
            runner: windows-latest
            separator: ';'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: ðŸ”¨ Build with PyInstaller (Windows)
        if: matrix.os == 'Windows'
        run: |
          pyinstaller --onefile --windowed `
            --name BulletinPro `
            --icon assets/icon.ico `
            --add-data "assets${{ matrix.separator }}assets" `
            main.py
      
      - name: ðŸ”¨ Build with PyInstaller (Linux)
        if: matrix.os == 'Linux'
        run: |
          pyinstaller --onefile --windowed \
            --name BulletinPro \
            --add-data "assets${{ matrix.separator }}assets" \
            main.py
      
      - name: ðŸ“¤ Upload PyInstaller artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-${{ matrix.os }}-build
          path: dist/
          if-no-files-found: error

  # CrÃ©er des packages .deb pour Linux
  create-deb:
    name: ðŸ“¦ Create .deb package
    needs: build-pyinstaller
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: pyinstaller-Linux-build
          path: ./dist
      
      - name: ðŸ”¨ Create .deb package
        run: |
          mkdir -p bulletinpro_${{ env.BUILD_VERSION }}/DEBIAN
          mkdir -p bulletinpro_${{ env.BUILD_VERSION }}/usr/bin
          mkdir -p bulletinpro_${{ env.BUILD_VERSION }}/usr/share/applications
          mkdir -p bulletinpro_${{ env.BUILD_VERSION }}/usr/share/icons/hicolor/256x256/apps
          
          # Copier l'exÃ©cutable
          chmod +x dist/BulletinPro
          cp dist/BulletinPro bulletinpro_${{ env.BUILD_VERSION }}/usr/bin/
          
          # CrÃ©er control
          cat > bulletinpro_${{ env.BUILD_VERSION }}/DEBIAN/control << EOF
          Package: bulletinpro
          Version: ${{ env.BUILD_VERSION }}
          Architecture: amd64
          Maintainer: BulletinPro Team
          Description: Application de gestion de bulletins scolaires
           SystÃ¨me complet de gestion des notes et bulletins.
          EOF
          
          # CrÃ©er .desktop
          cat > bulletinpro_${{ env.BUILD_VERSION }}/usr/share/applications/bulletinpro.desktop << EOF
          [Desktop Entry]
          Name=BulletinPro
          Comment=Gestion de bulletins scolaires
          Exec=/usr/bin/BulletinPro
          Icon=bulletinpro
          Type=Application
          Categories=Education;Office;
          Terminal=false
          EOF
          
          # Construire .deb
          dpkg-deb --build bulletinpro_${{ env.BUILD_VERSION }}
          mv bulletinpro_${{ env.BUILD_VERSION }}.deb BulletinPro-${{ env.BUILD_VERSION }}.deb
      
      - name: ðŸ“¤ Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-deb-package
          path: BulletinPro-*.deb

  # Release si tag
  create-release:
    name: ðŸš€ Create Release
    needs: [build-flet, build-pyinstaller, create-deb]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: ðŸ“‹ List artifacts
        run: ls -lhR ./artifacts
      
      - name: ðŸ“¦ Prepare release files
        run: |
          # Flet builds (prioritaire)
          if [ -d "artifacts/flet-Windows-build" ]; then
            cd artifacts/flet-Windows-build
            zip -r ../../BulletinPro-Windows-Flet.zip ./*
            cd ../..
          fi
          
          if [ -d "artifacts/flet-Linux-build" ]; then
            find artifacts/flet-Linux-build -name "*.deb" -exec cp {} BulletinPro-Linux-Flet.deb \;
          fi
          
          # PyInstaller builds (backup)
          if [ -d "artifacts/pyinstaller-Windows-build" ]; then
            cd artifacts/pyinstaller-Windows-build
            zip -r ../../BulletinPro-Windows-PyInstaller.zip ./*
            cd ../..
          fi
          
          if [ -f "artifacts/bulletinpro-deb-package/BulletinPro-"*.deb ]; then
            cp artifacts/bulletinpro-deb-package/BulletinPro-*.deb BulletinPro-Linux-PyInstaller.deb
          fi
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            BulletinPro-Windows-Flet.zip
            BulletinPro-Linux-Flet.deb
            BulletinPro-Windows-PyInstaller.zip
            BulletinPro-Linux-PyInstaller.deb
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸ“¦ BulletinPro ${{ github.ref_name }}
            
            ### ðŸŽ¯ Versions disponibles
            
            **ðŸ¦‹ Flet (RecommandÃ© - Interface native Flutter):**
            - `BulletinPro-Windows-Flet.zip` - Windows 10/11
            - `BulletinPro-Linux-Flet.deb` - Ubuntu/Debian
            
            **ðŸ PyInstaller (Alternative - Plus simple):**
            - `BulletinPro-Windows-PyInstaller.zip` - Windows 10/11
            - `BulletinPro-Linux-PyInstaller.deb` - Ubuntu/Debian
            
            ### ðŸ“¥ Installation
            
            **Windows:**
            1. TÃ©lÃ©chargez le .zip de votre choix
            2. Extrayez le contenu
            3. Lancez l'exÃ©cutable
            
            **Linux (Ubuntu/Debian):**
            ```bash
            sudo dpkg -i BulletinPro-Linux-*.deb
            sudo apt-get install -f  # RÃ©soudre les dÃ©pendances si nÃ©cessaire
            ```
            
            ### ðŸ“ Notes
            - Version: ${{ env.BUILD_VERSION }}
            - Les builds Flet offrent une meilleure performance et interface native
            - Les builds PyInstaller sont plus simples mais plus volumineux
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: ðŸ“Š Build Summary
    needs: [build-flet, build-pyinstaller, create-deb]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ‰ BulletinPro Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.BUILD_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¦‹ Flet Builds (Native)" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-flet.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build-flet.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ PyInstaller Builds (Fallback)" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build-pyinstaller.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build-pyinstaller.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DEB Package | ${{ needs.create-deb.result }} |" >> $GITHUB_STEP_SUMMARY
