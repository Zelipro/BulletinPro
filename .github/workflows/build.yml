name: ðŸš€ Desktop Builds (Linux, macOS, Windows)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.12.8
  FLET_CLI_VERSION: 0.27.5
  FLUTTER_VERSION: 3.30.0  # âœ… Fix: Dart 3.7+ requis pour webview_flutter_android 4.10.5
  PYTHONUTF8: 1
  FLET_CLI_NO_RICH_OUTPUT: 1
  UV_NO_PROGRESS: 1

jobs:
  build-linux:
    name: ðŸ§ Build Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ¦‹ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: ðŸ”§ Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
      
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==$FLET_CLI_VERSION
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ”¨ Flet Build Linux
        run: |
          flet build linux --verbose --build-number=$BUILD_NUMBER --build-version=$BUILD_VERSION
      
      - name: ðŸ” Verify build output
        run: |
          echo "ðŸ“‚ Contents of build/linux:"
          ls -lhR build/linux || echo "âŒ build/linux not found"
          
          echo ""
          echo "ðŸ” Searching for .deb files:"
          find build -name "*.deb" -type f || echo "âš ï¸ No .deb files found"
      
      - name: ðŸ“¤ Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-linux-${{ env.BUILD_VERSION }}
          path: build/linux
          if-no-files-found: error
          retention-days: 30

  build-macos:
    name: ðŸŽ Build macOS
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ¦‹ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==$FLET_CLI_VERSION
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ðŸ”¨ Flet Build macOS
        run: |
          flet build macos --verbose --build-number=$BUILD_NUMBER --build-version=$BUILD_VERSION
      
      - name: ðŸ” Verify build output
        run: |
          echo "ðŸ“‚ Contents of build/macos:"
          ls -lhR build/macos || echo "âŒ build/macos not found"
          
          echo ""
          echo "ðŸ” Searching for .app bundles:"
          find build/macos -name "*.app" -type d || echo "âš ï¸ No .app bundles found"
      
      - name: ðŸ“¤ Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-macos-${{ env.BUILD_VERSION }}
          path: build/macos
          if-no-files-found: error
          retention-days: 30

  build-windows:
    name: ðŸªŸ Build Windows
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ¦‹ Setup Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet-cli==$env:FLET_CLI_VERSION
          if (Test-Path requirements.txt) {
            pip install -r requirements.txt
          }
      
      - name: ðŸ”¨ Flet Build Windows
        run: |
          flet build windows --verbose --no-rich-output --build-number=$env:BUILD_NUMBER --build-version=$env:BUILD_VERSION
      
      - name: ðŸ” Verify build output
        run: |
          Write-Host "ðŸ“‚ Contents of build/windows:"
          if (Test-Path build/windows) {
            Get-ChildItem -Path build/windows -Recurse | Format-Table -AutoSize
          } else {
            Write-Host "âŒ build/windows not found"
          }
          
          Write-Host ""
          Write-Host "ðŸ” Searching for .exe files:"
          if (Test-Path build) {
            Get-ChildItem -Path build -Recurse -Filter *.exe -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "âœ… Found: $($_.FullName)"
            }
          }
      
      - name: ðŸ“¤ Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-windows-${{ env.BUILD_VERSION }}
          path: build/windows
          if-no-files-found: error
          retention-days: 30

  create-release:
    name: ðŸš€ Create GitHub Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: ðŸ“‹ List downloaded artifacts
        run: |
          echo "ðŸ“‚ Artifacts directory structure:"
          ls -lhR ./artifacts
      
      - name: ðŸ“¦ Package releases
        run: |
          # Linux - copier .deb si disponible
          if [ -d "artifacts/bulletinpro-linux-${{ env.BUILD_VERSION }}" ]; then
            cd "artifacts/bulletinpro-linux-${{ env.BUILD_VERSION }}"
            if ls *.deb 1> /dev/null 2>&1; then
              cp *.deb ../../BulletinPro-${{ env.BUILD_VERSION }}-Linux.deb
              echo "âœ… Linux .deb created"
            else
              # Si pas de .deb, crÃ©er une archive
              tar -czf ../../BulletinPro-${{ env.BUILD_VERSION }}-Linux.tar.gz ./*
              echo "âœ… Linux tar.gz created"
            fi
            cd ../..
          fi
          
          # macOS - crÃ©er DMG ou ZIP
          if [ -d "artifacts/bulletinpro-macos-${{ env.BUILD_VERSION }}" ]; then
            cd "artifacts/bulletinpro-macos-${{ env.BUILD_VERSION }}"
            zip -r ../../BulletinPro-${{ env.BUILD_VERSION }}-macOS.zip ./*
            echo "âœ… macOS zip created"
            cd ../..
          fi
          
          # Windows - crÃ©er ZIP
          if [ -d "artifacts/bulletinpro-windows-${{ env.BUILD_VERSION }}" ]; then
            cd "artifacts/bulletinpro-windows-${{ env.BUILD_VERSION }}"
            zip -r ../../BulletinPro-${{ env.BUILD_VERSION }}-Windows.zip ./*
            echo "âœ… Windows zip created"
            cd ../..
          fi
          
          echo ""
          echo "ðŸ“¦ Final release files:"
          ls -lh BulletinPro-*
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            BulletinPro-*.deb
            BulletinPro-*.tar.gz
            BulletinPro-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸ“¦ BulletinPro ${{ github.ref_name }}
            
            ### ðŸ“¥ Installation
            
            **ðŸ§ Linux (Ubuntu/Debian):**
            ```bash
            # Si fichier .deb disponible:
            sudo dpkg -i BulletinPro-${{ env.BUILD_VERSION }}-Linux.deb
            sudo apt-get install -f
            
            # Sinon avec tar.gz:
            tar -xzf BulletinPro-${{ env.BUILD_VERSION }}-Linux.tar.gz
            cd bundle
            ./bulletinpro
            ```
            
            **ðŸŽ macOS:**
            ```bash
            # Extraire le zip
            unzip BulletinPro-${{ env.BUILD_VERSION }}-macOS.zip
            
            # Ouvrir l'application
            open BulletinPro.app
            ```
            
            **ðŸªŸ Windows:**
            1. TÃ©lÃ©chargez `BulletinPro-${{ env.BUILD_VERSION }}-Windows.zip`
            2. Extrayez le contenu
            3. Naviguez vers le dossier `runner/Release` ou `x64/runner/Release`
            4. Lancez `bulletinpro.exe`
            
            ### ðŸ“ Informations
            - **Version:** ${{ env.BUILD_VERSION }}
            - **Build:** ${{ env.BUILD_NUMBER }}
            - **Python:** ${{ env.PYTHON_VERSION }}
            - **Flutter:** ${{ env.FLUTTER_VERSION }}
            - **Flet:** ${{ env.FLET_CLI_VERSION }}
            
            ### âš ï¸ Notes importantes
            - **Windows:** L'antivirus peut bloquer l'application au premier lancement (faux positif)
            - **macOS:** Vous devrez peut-Ãªtre autoriser l'app dans PrÃ©fÃ©rences SystÃ¨me > SÃ©curitÃ©
            - **Linux:** Assurez-vous d'avoir GTK3 installÃ© (`sudo apt install libgtk-3-0`)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: ðŸ“Š Build Summary
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ‰ BulletinPro Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $BUILD_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Number | $BUILD_NUMBER |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | $PYTHON_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter | $FLUTTER_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Flet CLI | $FLET_CLI_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Icon |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | ${{ needs.build-linux.result }} | ${{ needs.build-linux.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ macOS | ${{ needs.build-macos.result }} | ${{ needs.build-macos.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸªŸ Windows | ${{ needs.build-windows.result }} | ${{ needs.build-windows.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Message de conclusion
          if [ "${{ needs.build-linux.result }}" = "success" ] && \
             [ "${{ needs.build-macos.result }}" = "success" ] && \
             [ "${{ needs.build-windows.result }}" = "success" ]; then
            echo "### ðŸŽŠ Tous les builds ont rÃ©ussi !" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Les artifacts sont disponibles ci-dessous." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
              echo "ðŸš€ **Une release GitHub sera crÃ©Ã©e automatiquement.**" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ’¡ Pour crÃ©er une release, crÃ©ez un tag: \`git tag v$BUILD_VERSION && git push --tags\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âš ï¸ Certains builds ont Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Consultez les logs des jobs en erreur pour diagnostiquer le problÃ¨me." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ðŸ”§ ProblÃ¨mes courants :" >> $GITHUB_STEP_SUMMARY
            echo "- VÃ©rifiez que \`requirements.txt\` est prÃ©sent" >> $GITHUB_STEP_SUMMARY
            echo "- Assurez-vous que le fichier \`main.py\` existe" >> $GITHUB_STEP_SUMMARY
            echo "- VÃ©rifiez les dÃ©pendances Flutter (webview_flutter, etc.)" >> $GITHUB_STEP_SUMMARY
          fi
