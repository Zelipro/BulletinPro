name: Build BulletinPro

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    name: ðŸ§ Build Linux (.deb)
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libglib2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgdk-pixbuf2.0-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev
      
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true
      
      - name: ðŸ” Flutter doctor
        run: flutter doctor -v
      
      - name: ðŸ“š Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§¹ Clean previous builds
        run: |
          rm -rf build/
          rm -rf dist/
      
      - name: ðŸ”¨ Build Linux with Flet
        run: |
          echo "ðŸš€ Starting Flet build..."
          flet build linux --verbose
        continue-on-error: false
      
      - name: ðŸ” Debug - List all files in build
        if: always()
        run: |
          echo "=== Contents of build directory ==="
          ls -lhR build/ || echo "Build directory doesn't exist"
          
          echo ""
          echo "=== Searching for all package files ==="
          find build -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" \) || echo "No package files found"
          
          echo ""
          echo "=== All files in build ==="
          find build -type f || echo "No files in build"
      
      - name: ðŸ“¦ Find .deb package
        id: find_package
        run: |
          # Chercher dans plusieurs emplacements possibles
          DEB_FILE=""
          
          # Option 1: build/linux
          if [ -z "$DEB_FILE" ]; then
            DEB_FILE=$(find build/linux -name "*.deb" -type f 2>/dev/null | head -n 1)
          fi
          
          # Option 2: Anywhere in build
          if [ -z "$DEB_FILE" ]; then
            DEB_FILE=$(find build -name "*.deb" -type f 2>/dev/null | head -n 1)
          fi
          
          # Option 3: Chercher dans dist
          if [ -z "$DEB_FILE" ]; then
            DEB_FILE=$(find dist -name "*.deb" -type f 2>/dev/null | head -n 1)
          fi
          
          if [ -z "$DEB_FILE" ]; then
            echo "âŒ ERROR: No .deb file found!"
            echo "Build may have failed. Check previous steps."
            exit 1
          fi
          
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
          echo "deb_name=$(basename $DEB_FILE)" >> $GITHUB_OUTPUT
          
          echo "âœ… Found .deb package:"
          ls -lh "$DEB_FILE"
      
      - name: ðŸ“¤ Upload Linux .deb
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-linux-deb
          path: ${{ steps.find_package.outputs.deb_file }}
          retention-days: 30
          if-no-files-found: error

  build-windows:
    name: ðŸªŸ Build Windows (.exe)
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          cache: true
      
      - name: ðŸ” Flutter doctor
        run: flutter doctor -v
      
      - name: ðŸ“š Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§¹ Clean previous builds
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
      
      - name: ðŸ”¨ Build Windows with Flet
        run: |
          Write-Host "ðŸš€ Starting Flet build..."
          flet build windows --verbose
      
      - name: ðŸ” Debug - List all files in build
        if: always()
        run: |
          Write-Host "=== Contents of build directory ==="
          if (Test-Path build) {
            Get-ChildItem -Path build -Recurse | Format-Table -AutoSize
          } else {
            Write-Host "Build directory doesn't exist"
          }
          
          Write-Host ""
          Write-Host "=== Searching for .exe files ==="
          if (Test-Path build) {
            Get-ChildItem -Path build -Recurse -Filter *.exe | ForEach-Object {
              Write-Host $_.FullName
            }
          }
      
      - name: ðŸ“¦ Find and package Windows exe
        id: package_exe
        run: |
          # Chercher le fichier .exe
          $exeFiles = Get-ChildItem -Path "build" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
          
          if ($exeFiles.Count -eq 0) {
            Write-Error "âŒ No .exe file found!"
            exit 1
          }
          
          $exeFile = $exeFiles[0].FullName
          $exeName = $exeFiles[0].Name
          
          Write-Host "âœ… Found .exe: $exeFile"
          
          # CrÃ©er un dossier pour le package
          $packageDir = "BulletinPro-Windows"
          New-Item -ItemType Directory -Force -Path $packageDir
          
          # Copier l'exe et les dÃ©pendances si elles existent
          Copy-Item $exeFile $packageDir/
          
          # Copier les DLLs si elles existent
          $exeDir = Split-Path $exeFile
          if (Test-Path "$exeDir/*.dll") {
            Copy-Item "$exeDir/*.dll" $packageDir/
          }
          
          # CrÃ©er le ZIP
          $zipName = "BulletinPro-Windows.zip"
          Compress-Archive -Path $packageDir/* -DestinationPath $zipName -Force
          
          Write-Host "âœ… Package created: $zipName"
          
          # Output pour les Ã©tapes suivantes
          echo "zip_file=$zipName" >> $env:GITHUB_OUTPUT
          echo "exe_name=$exeName" >> $env:GITHUB_OUTPUT
      
      - name: ðŸ“¤ Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: bulletinpro-windows-exe
          path: ${{ steps.package_exe.outputs.zip_file }}
          retention-days: 30
          if-no-files-found: error

  create-release:
    name: ðŸš€ Create Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: bulletinpro-linux-deb
          path: ./release/linux
      
      - name: ðŸ“¥ Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: bulletinpro-windows-exe
          path: ./release/windows
      
      - name: ðŸ“‹ List downloaded artifacts
        run: |
          echo "=== Linux packages ==="
          ls -lh ./release/linux/
          
          echo ""
          echo "=== Windows packages ==="
          ls -lh ./release/windows/
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./release/linux/*
            ./release/windows/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ðŸ“¦ BulletinPro - Version ${{ github.ref_name }}
            
            ### Installation
            
            **Linux (Ubuntu/Debian):**
            ```bash
            sudo dpkg -i bulletinpro*.deb
            ```
            
            **Windows:**
            1. TÃ©lÃ©chargez le fichier ZIP
            2. Extrayez-le
            3. Lancez BulletinPro.exe
            
            ### NouveautÃ©s
            Consultez les notes de version ci-dessous.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Job de summary
  build-summary:
    name: ðŸ“Š Build Summary
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Display summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ Linux | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸªŸ Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Les fichiers compilÃ©s sont disponibles dans la section **Artifacts** ci-dessous." >> $GITHUB_STEP_SUMMARY
